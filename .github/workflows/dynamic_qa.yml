name: dynamic-qa-env

on:
  pull_request:
    types: [opened, synchronize, closed, ready_for_review, converted_to_draft]
    branches:
      - main
  workflow_dispatch:

env:
  PACKAGE_NAME: feature-${{ github.event.pull_request.number }}


jobs:
  create-deployment-preview:
    if: >
      (github.event.action == 'opened' || github.event.action == 'ready_for_review' || github.event.action == 'reopened') && 
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

#      - name: Initial Deployment Preview Comment
#        uses: peter-evans/create-or-update-comment@v1.4.5
#        id: pr-preview-comment
#        with:
#          issue-number: ${{ github.event.pull_request.number }}
#          body: |
#            ### Building Deployment Preview..
#            A preview of this Pull Request is being created. Hold tight while it's building âš’ï¸
#            This comment will be automatically updated when the preview is ready.

      - name: Create ZIP deployment package
        run: |
          cd restaurant_picker
          zip -r ../$PACKAGE_NAME . *

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "us-east-2"

      - name: Upload package to S3 bucket
        run: aws s3 cp $PACKAGE_ZIP s3://restaurant-picker/$PACKAGE_NAME/
        env:
          PACKAGE_ZIP: $PACKAGE_NAME.zip

#      Not New after this

#      - name: Create Docker Image
#        run: |
#          docker build \
#            --build-arg BRYNTUM_REPO_KEY=${{ secrets.BRYNTUM_REPO_KEY }} \
#            -f docker/Dockerfile \
#            -t mybldreusprdhubacr.azurecr.io/bldrbase:pr-${{ github.event.pull_request.number }} .
#
#      - name: Azure Login
#        run: |
#          az login --service-principal \
#            -u ${{ secrets.SERVICE_PRINCIPAL_CLIENT_ID }} \
#            -p ${{ secrets.SERVICE_PRINCIPAL_CLIENT_SECRET }} \
#            --tenant ${{ secrets.SERVICE_PRINCIPAL_TENANT_ID }}
#
#      - name: Set Account to MyBLDR Dev/Test
#        run: |
#          az account set --name "MyBLDR Dev/Test"
#
#      - name: Login to MyBLDR Registry and Upload Image
#        run: |
#          az acr login --name mybldreusprdhubacr
#          docker push mybldreusprdhubacr.azurecr.io/bldrbase:pr-${{ github.event.pull_request.number }}
#
#      - name: Create the PR Deployment Slot
#        run: |
#          az webapp deployment slot create \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --configuration-source bldr-eastus-dev-exp-webapp \
#            --slot preview-pr-${{ github.event.pull_request.number }}
#
#      - name: Set Slot-Specific Environment Variables
#        run: |
#          az webapp config appsettings set \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }} \
#            --settings \
#            WEBSITESPORT=80 \
#            DJANGO_SETTINGS_MODULE=web.qa \
#            DOCKER_REGISTRY_SERVER_USERNAME=${{ secrets.SERVICE_PRINCIPAL_CLIENT_ID }} \
#            APP_VERSION=${{ github.sha }} \
#            DOCKER_REGISTRY_SERVER_PASSWORD=${{ secrets.SERVICE_PRINCIPAL_CLIENT_SECRET }}
#
#      - name: Assign Managed Identity to Deployment Slot
#        run: |
#          az webapp identity assign \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }} \
#            --identities /subscriptions/a15dc3fb-1dc0-46a8-a6f6-e520f05af58a/resourcegroups/bldr-eastus-dev-exp-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/bldr-eastus-dev-exp-uai
#
#      - name: Enable Container Logging
#        run: |
#          az webapp log config \
#          --name bldr-eastus-dev-exp-webapp \
#          --resource-group bldr-eastus-dev-exp-rg \
#          --slot preview-pr-${{ github.event.pull_request.number }} \
#          --docker-container-logging filesystem
#
#      - name: Enable VNet Integration on Deployment Slot
#        run: |
#          az webapp vnet-integration add \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }} \
#            --vnet bldr-eastus-dev-exp-vnet \
#            --subnet applications-sn
#
#      # https://learn.microsoft.com/en-us/azure/app-service/app-service-key-vault-references?tabs=azure-cli#access-vaults-with-a-user-assigned-identity
#      - name: Access Key Vault with a User-Assigned Identity
#        run: |
#          userAssignedIdentityResourceId=$(az identity show -g bldr-eastus-dev-exp-rg -n bldr-eastus-dev-exp-uai --query id -o tsv)
#          appResourceId=$(az webapp show -g bldr-eastus-dev-exp-rg -n bldr-eastus-dev-exp-webapp --slot preview-pr-${{ github.event.pull_request.number }} --query id -o tsv)
#          az rest --method PATCH --uri "${appResourceId}?api-version=2021-01-01" --body "{'properties':{'keyVaultReferenceIdentity':'${userAssignedIdentityResourceId}'}}"
#
#      - name: Deploy to Azure Web App
#        uses: azure/webapps-deploy@v2
#        id: deploy-to-webapp
#        with:
#          app-name: bldr-eastus-dev-exp-webapp
#          slot-name: preview-pr-${{ github.event.pull_request.number }}
#          images: mybldreusprdhubacr.azurecr.io/bldrbase:pr-${{ github.event.pull_request.number }}
#
#      - name: Get App Service deployment slots
#        id: get_slots
#        run: |
#          echo "SLOT_COUNT=$(az webapp deployment slot list --name bldr-eastus-dev-exp-webapp --resource-group bldr-eastus-dev-exp-rg --query 'length([])')" >> $GITHUB_ENV
#
#      - name: Update PR Preview Comment
#        uses: peter-evans/create-or-update-comment@v1.4.5
#        with:
#          comment-id: ${{ steps.pr-preview-comment.outputs.comment-id }}
#          edit-mode: replace
#          body: |
#            ### Deployment Preview
#            ğŸ˜ Preview this PR: https://bldr-eastus-dev-exp-webapp-preview-pr-${{ github.event.pull_request.number }}.azurewebsites.net
#            ğŸ§‘ğŸ¼â€ğŸ’» Commit SHA: ${{ github.sha }}
#            ğŸ§® Slot Count: ${{ env.SLOT_COUNT }} / 20
#          reactions: 'rocket'

  update-deployment-preview:
    if: >
      github.event.action == 'synchronize' && 
      github.event.pull_request.draft == false && 
      github.event.action != 'ready_for_review'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}

#      - name: Find PR Preview Comment
#        uses: peter-evans/find-comment@v1
#        id: deploy-preview-comment
#        with:
#          issue-number: ${{ github.event.pull_request.number }}
#          comment-author: 'github-actions[bot]'
#          body-includes: Deployment Preview
#
#      - name: Update PR Preview Comment
#        if: steps.deploy-preview-comment.outputs.comment-id != ''
#        uses: peter-evans/create-or-update-comment@v1.4.5
#        with:
#          comment-id: ${{ steps.deploy-preview-comment.outputs.comment-id }}
#          edit-mode: replace
#          body: |
#            ### Building Deployment Preview..
#            The Pull Request preview is being updated. Hold tight while it's building âš’ï¸
#            This comment will be automatically updated when the new version is ready.

      - name: Create ZIP deployment package
        run: |
          cd restaurant_picker
          zip -r ../$PACKAGE_NAME . *

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "us-east-2"

      - name: Upload package to S3 bucket
        run: aws s3 cp $PACKAGE_ZIP s3://restaurant-picker/$PACKAGE_NAME/
        env:
          PACKAGE_ZIP: $PACKAGE_NAME.zip

#      - name: Delete PR Deployment Slot
#        run: |
#          az webapp deployment slot delete \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }}
#
#      - name: Delete the Associated Docker Image
#        run: |
#          az acr login --name mybldreusprdhubacr
#          az acr repository delete \
#            --name mybldreusprdhubacr \
#            --image bldrbase:pr-${{ github.event.pull_request.number }} \
#            --yes
#
#      - name: Create Docker Image
#        run: |
#          docker build \
#            --build-arg BRYNTUM_REPO_KEY=${{ secrets.BRYNTUM_REPO_KEY }} \
#            -f docker/Dockerfile \
#            -t mybldreusprdhubacr.azurecr.io/bldrbase:pr-${{ github.event.pull_request.number }} .
#
#      - name: Azure Login
#        run: |
#          az login --service-principal \
#            -u ${{ secrets.SERVICE_PRINCIPAL_CLIENT_ID }} \
#            -p ${{ secrets.SERVICE_PRINCIPAL_CLIENT_SECRET }} \
#            --tenant ${{ secrets.SERVICE_PRINCIPAL_TENANT_ID }}
#
#      - name: Set Account to MyBLDR Dev/Test
#        run: |
#          az account set --name "MyBLDR Dev/Test"
#
#      - name: Login to MyBLDR Registry and Upload Image
#        run: |
#          az acr login --name mybldreusprdhubacr
#          docker push mybldreusprdhubacr.azurecr.io/bldrbase:pr-${{ github.event.pull_request.number }}
#
#      - name: Create the PR Deployment Slot
#        run: |
#          az webapp deployment slot create \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --configuration-source bldr-eastus-dev-exp-webapp \
#            --slot preview-pr-${{ github.event.pull_request.number }}
#
#      - name: Set Slot-Specific Environment Variables
#        run: |
#          az webapp config appsettings set \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }} \
#            --settings \
#            WEBSITESPORT=80 \
#            DJANGO_SETTINGS_MODULE=web.qa \
#            DOCKER_REGISTRY_SERVER_USERNAME=${{ secrets.SERVICE_PRINCIPAL_CLIENT_ID }} \
#            APP_VERSION=${{ github.sha }} \
#            DOCKER_REGISTRY_SERVER_PASSWORD=${{ secrets.SERVICE_PRINCIPAL_CLIENT_SECRET }}
#
#      - name: Assign Managed Identity to Deployment Slot
#        run: |
#          az webapp identity assign \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }} \
#            --identities /subscriptions/a15dc3fb-1dc0-46a8-a6f6-e520f05af58a/resourcegroups/bldr-eastus-dev-exp-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/bldr-eastus-dev-exp-uai
#
#      - name: Enable Container Logging
#        run: |
#          az webapp log config \
#          --name bldr-eastus-dev-exp-webapp \
#          --resource-group bldr-eastus-dev-exp-rg \
#          --slot preview-pr-${{ github.event.pull_request.number }} \
#          --docker-container-logging filesystem
#
#      - name: Enable VNet Integration on Deployment Slot
#        run: |
#          az webapp vnet-integration add \
#            --name bldr-eastus-dev-exp-webapp \
#            --resource-group bldr-eastus-dev-exp-rg \
#            --slot preview-pr-${{ github.event.pull_request.number }} \
#            --vnet bldr-eastus-dev-exp-vnet \
#            --subnet applications-sn
#
#      # https://learn.microsoft.com/en-us/azure/app-service/app-service-key-vault-references?tabs=azure-cli#access-vaults-with-a-user-assigned-identity
#      - name: Access Key Vault with a User-Assigned Identity
#        run: |
#          userAssignedIdentityResourceId=$(az identity show -g bldr-eastus-dev-exp-rg -n bldr-eastus-dev-exp-uai --query id -o tsv)
#          appResourceId=$(az webapp show -g bldr-eastus-dev-exp-rg -n bldr-eastus-dev-exp-webapp --slot preview-pr-${{ github.event.pull_request.number }} --query id -o tsv)
#          az rest --method PATCH --uri "${appResourceId}?api-version=2021-01-01" --body "{'properties':{'keyVaultReferenceIdentity':'${userAssignedIdentityResourceId}'}}"
#
#      - name: Deploy to Azure Web App
#        uses: azure/webapps-deploy@v2
#        id: deploy-to-webapp
#        with:
#          app-name: bldr-eastus-dev-exp-webapp
#          slot-name: preview-pr-${{ github.event.pull_request.number }}
#          images: mybldreusprdhubacr.azurecr.io/bldrbase:pr-${{ github.event.pull_request.number }}
#
#      - name: Get App Service deployment slots
#        id: get_slots
#        run: |
#          echo "SLOT_COUNT=$(az webapp deployment slot list --name bldr-eastus-dev-exp-webapp --resource-group bldr-eastus-dev-exp-rg --query 'length([])')" >> $GITHUB_ENV
#
#      - name: Update PR Preview Comment
#        uses: peter-evans/create-or-update-comment@v1.4.5
#        with:
#          comment-id: ${{ steps.deploy-preview-comment.outputs.comment-id }}
#          edit-mode: replace
#          body: |
#            ### Deployment Preview
#            ğŸ˜ Preview this PR: https://bldr-eastus-dev-exp-webapp-preview-pr-${{ github.event.pull_request.number }}.azurewebsites.net
#            ğŸ§‘ğŸ¼â€ğŸ’» Commit SHA: ${{ github.sha }}
#            ğŸ§® Slot Count: ${{ env.SLOT_COUNT }} / 20


  delete-deployment-preview:
    if: github.event.action == 'closed' || github.event.action == 'converted_to_draft'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "us-east-2"

      - name: Remove package from S3 bucket
        run: aws s3 rm s3://restaurant-picker/$PACKAGE_NAME/$PACKAGE_ZIP
        env:
          PACKAGE_ZIP: $PACKAGE_NAME.zip

#      - name: Find PR Preview Comment
#        uses: peter-evans/find-comment@v1
#        id: deploy-preview-comment
#        with:
#          issue-number: ${{ github.event.pull_request.number }}
#          comment-author: 'github-actions[bot]'
#          body-includes: Deployment Preview
#
#      - name: Update PR Preview Comment
#        if: steps.deploy-preview-comment.outputs.comment-id != ''
#        uses: peter-evans/create-or-update-comment@v1.4.5
#        with:
#          comment-id: ${{ steps.deploy-preview-comment.outputs.comment-id }}
#          edit-mode: replace
#          body: |
#            ### Deployment Preview
#            ğŸ This PR has been closed. No deployment preview is available.
#          reactions: 'hooray'
